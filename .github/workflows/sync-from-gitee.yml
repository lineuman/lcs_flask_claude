name: Sync from Gitee to GitHub

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    # æ¯å¤© UTC 06,14,15,16ï¼ˆä¸œå…«åŒº 14,22,23,24ï¼‰
    - cron: '0 6,14,15,16 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # ğŸ‘‡ åœ¨æ­¤å¤„ç›´æ¥å®šä¹‰ä½ è¦åŒæ­¥çš„ä»“åº“
        repos:
          - name: "Project A"
            gitee_url: "https://gitee.com/yourname/repo-a.git"
            gitee_branch: "main"
            github_repo: "repo-a"
            github_branch: "main"
            private: false

          - name: "Project B"
            gitee_url: "https://gitee.com/yourname/repo-b.git"
            gitee_branch: "dev"
            github_repo: "repo-b"
            github_branch: "main"
            private: true

          # å¯ç»§ç»­æ·»åŠ æ›´å¤š
      fail-fast: false

    steps:
      - name: Set Config from Matrix
        id: config
        run: |
          echo "name=${{ matrix.repos.name }}" >> $GITHUB_OUTPUT
          echo "gitee_url=${{ matrix.repos.gitee_url }}" >> $GITHUB_OUTPUT
          echo "gitee_branch=${{ matrix.repos.gitee_branch }}" >> $GITHUB_OUTPUT
          echo "github_repo=${{ matrix.repos.github_repo }}" >> $GITHUB_OUTPUT
          echo "github_branch=${{ matrix.repos.github_branch }}" >> $GITHUB_OUTPUT
          echo "private=${{ matrix.repos.private }}" >> $GITHUB_OUTPUT

      - name: Ensure GitHub Repository Exists
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ steps.config.outputs.github_repo }}
          PRIVATE: ${{ steps.config.outputs.private }}
        run: |
          url="https://api.github.com/repos/$OWNER/$REPO"
          if curl -s -H "Authorization: Bearer $GH_TOKEN" "$url" | jq -e '.id' > /dev/null; then
            echo "âœ… ä»“åº“å·²å­˜åœ¨ï¼Œæ›´æ–°ç§æœ‰æ€§"
            curl -X PATCH -H "Authorization: Bearer $GH_TOKEN" \
                 -H "Accept: application/vnd.github.v3+json" \
                 "$url" -d "{\"private\":$PRIVATE}"
          else
            echo "ğŸ“¦ ä»“åº“ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º"
            curl -X POST -H "Authorization: Bearer $GH_TOKEN" \
                 -H "Accept: application/vnd.github.v3+json" \
                 https://api.github.com/user/repos \
                 -d "{\"name\":\"$REPO\", \"private\":$PRIVATE}"
          fi

      - name: Clone from Gitee and Push to GitHub
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITEE_USERNAME: ${{ secrets.GITEE_USERNAME }}
          GITEE_PASSWORD: ${{ secrets.GITEE_PASSWORD }}
          GITEE_URL: ${{ steps.config.outputs.gitee_url }}
          GITEE_BRANCH: ${{ steps.config.outputs.gitee_branch }}
          GITHUB_REPO: ${{ steps.config.outputs.github_repo }}
          GITHUB_BRANCH: ${{ steps.config.outputs.github_branch }}
          OWNER: ${{ github.repository_owner }}
          NAME: ${{ steps.config.outputs.name }}
        run: |
          set -eux

          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # æ„é€ å¸¦è®¤è¯çš„ Gitee URL
          AUTH_URL=$(echo "$GITEE_URL" | sed "s|https://|https://$GITEE_USERNAME:$GITEE_PASSWORD@|")

          # å…‹éš† Gitee ä»“åº“
          git clone -b "$GITEE_BRANCH" --depth=1 "$AUTH_URL" cloned_repo
          cd cloned_repo

          # æ£€æŸ¥æ˜¯å¦ä¸ºç©º
          if [ -z "$(ls -A .)" ]; then
            echo "âš ï¸ ä»“åº“ä¸ºç©ºï¼Œè·³è¿‡"
            exit 0
          fi

          COMMIT=$(git rev-parse HEAD)

          # å¤åˆ¶å†…å®¹åˆ°æ–°ç›®å½•ï¼ˆæ’é™¤ .git å’Œ .githubï¼‰
          cd ..
          mkdir -p workspace
          rsync -av --exclude='.git' --exclude='.github' cloned_repo/ workspace/
          cd workspace

          # åˆå§‹åŒ–å¹¶æ¨é€åˆ° GitHub
          git init
          git checkout -b "$GITHUB_BRANCH"
          git add .
          git commit -m "Sync from Gitee: $NAME\n\nGitee Commit: $COMMIT"

          git remote add origin "https://$GH_TOKEN@github.com/$OWNER/$GITHUB_REPO.git"
          git push -f origin "$GITHUB_BRANCH"

          echo "ğŸ‰ åŒæ­¥å®Œæˆ: $NAME"
